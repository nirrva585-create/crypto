<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Signals • Stable & Strict</title>
  <style>
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --text: #d1d5db;
      --green: #10b981;
      --red: #ef4444;
    }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
    }
    header {
      text-align: center;
      padding: 12px;
      background: var(--card);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }
    #status {
      color: #9ca3af;
      font-size: 0.85rem;
      margin-top: 6px;
    }
    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 12px 0;
    }
    input, button {
      padding: 8px 14px;
      border-radius: 6px;
      background: #1f2937;
      border: 1px solid #374151;
      color: white;
      font-size: 0.9rem;
    }
    button {
      background: #3b82f6;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.92; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.9rem;
    }
    th, td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid #374151;
    }
    th {
      background: #0f172a;
      font-weight: 500;
      color: #9ca3af;
    }
    tr:hover {
      background: rgba(16,185,129,0.08);
    }
    .strong-buy { background: rgba(16,185,129,0.22); color: var(--green); font-weight: 700; }
    .buy       { color: var(--green); font-weight: 600; }
    .sell      { color: var(--red);   font-weight: 600; }
    .strong-sell { background: rgba(239,68,68,0.22); color: var(--red); font-weight: 700; }
    .neutral   { color: #9ca3af; font-style: italic; }
    .no-data {
      text-align: center;
      padding: 50px 20px;
      color: #6b7280;
      font-style: italic;
    }
  </style>
</head>
<body>

<header>
  <h1>Crypto Signals</h1>
  <div id="status">Initializing...</div>
</header>

<div class="controls">
  <input type="text" id="search" placeholder="Search coin...">
  <button id="refresh">↻ Refresh Now</button>
</div>

<table id="table">
  <thead>
    <tr>
      <th>Coin</th>
      <th>Price</th>
      <th>24h</th>
      <th>Signal</th>
      <th>Entry → TP / SL</th>
    </tr>
  </thead>
  <tbody id="tbody">
    <tr><td colspan="5" class="no-data">Loading strong signals...</td></tr>
  </tbody>
</table>

<script>
const COINGECKO = 'https://api.coingecko.com/api/v3';

async function fetchWithRetry(url, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const res = await fetch(url);
      if (res.ok) return await res.json();

      if (res.status === 429) {
        const wait = 8000 * attempt;
        document.getElementById('status').textContent = `Rate limit – wait ${wait/1000}s...`;
        await new Promise(r => setTimeout(r, wait));
        continue;
      }

      throw new Error(`HTTP ${res.status}`);
    } catch (err) {
      if (attempt === maxRetries) {
        document.getElementById('status').textContent = 'Network or API error – retrying soon...';
        throw err;
      }
      await new Promise(r => setTimeout(r, 4000));
    }
  }
  throw new Error('Max retries reached');
}

async function loadData() {
  const status = document.getElementById('status');
  status.textContent = 'Fetching real-time data...';

  try {
    // 1. BTC (small request)
    const btcData = await fetchWithRetry(`${COINGECKO}/coins/markets?vs_currency=usd&ids=bitcoin`);
    const btc24h = btcData[0]?.price_change_percentage_24h || 0;

    await new Promise(r => setTimeout(r, 1200)); // polite delay

    // 2. Main coins
    const coins = await fetchWithRetry(
      `${COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h`
    );

    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    let ranked = [];

    coins.forEach(c => {
      if ((c.market_cap || 0) < 200_000_000 || (c.total_volume || 0) < 30_000_000) return;

      const ch24 = c.price_change_percentage_24h || 0;
      const volRatio = (c.total_volume || 0) / (c.market_cap || 1);
      const rel = ch24 - btc24h;

      let signal = 'NEUTRAL';
      let cls = 'neutral';

      if (ch24 > 10 && volRatio > 4 && rel > 6) {
        signal = 'STRONG BUY';
        cls = 'strong-buy';
      } else if (ch24 > 6 && volRatio > 2.5 && rel > 3) {
        signal = 'BUY';
        cls = 'buy';
      } else if (ch24 < -10 && volRatio > 4 && rel < -6) {
        signal = 'STRONG SELL';
        cls = 'strong-sell';
      } else if (ch24 < -6 && volRatio > 2.5 && rel < -3) {
        signal = 'SELL';
        cls = 'sell';
      }

      if (signal === 'NEUTRAL') return;

      const entry = c.current_price;
      const tp = (entry * 1.18).toFixed(4);
      const sl = (entry * 0.91).toFixed(4);

      ranked.push({
        name: c.name,
        symbol: c.symbol.toUpperCase(),
        image: c.image,
        price: entry,
        ch24: ch24.toFixed(2),
        signal,
        cls,
        entry: entry.toFixed(4),
        tp,
        sl
      });
    });

    ranked.sort((a,b) => {
      const sa = a.signal.includes('STRONG') ? 1000 : a.signal.includes('BUY') || a.signal.includes('SELL') ? 500 : 0;
      const sb = b.signal.includes('STRONG') ? 1000 : b.signal.includes('BUY') || b.signal.includes('SELL') ? 500 : 0;
      return sb - sa || Math.abs(b.ch24) - Math.abs(a.ch24);
    });

    if (ranked.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="no-data">No strong signals detected right now</td></tr>';
    } else {
      ranked.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:left">
            <img src="${c.image}" width="20" height="20" style="vertical-align:middle; margin-right:6px; border-radius:50%;">
            ${c.name} (${c.symbol})
          </td>
          <td>$${c.price.toLocaleString(undefined,{minimumFractionDigits:2,maxFractionDigits:6})}</td>
          <td>${c.ch24}%</td>
          <td class="${c.cls}">${c.signal}</td>
          <td>$${c.entry} → $${c.tp} / $${c.sl}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    status.textContent = `Updated: ${new Date().toLocaleTimeString()} • Auto-refresh every 60 seconds`;
  } catch (err) {
    status.textContent = 'Network or API error – retrying in 60 seconds...';
    console.error('Load error:', err.message);
  }
}

// Auto-refresh every 60 seconds – safe and stable
setInterval(loadData, 60000);

document.getElementById('refresh').onclick = loadData;

document.getElementById('search').oninput = function() {
  const term = this.value.trim().toLowerCase();
  document.querySelectorAll('#tbody tr').forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
};

window.onload = () => {
  loadData();
};
</script>
</body>
</html>
